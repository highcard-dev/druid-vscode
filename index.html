<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>VS Code Web</title>
    <link rel="stylesheet" href="./out/vs/workbench/workbench.web.main.css" />
  </head>
  <body style="margin: 0; height: 100vh">
    <div id="root" style="height: 100vh; width: 100vw"></div>
    <script src="./out/nls.messages.js"></script>
    <script src="./out/vs/loader.js"></script>
    <script>
      function getJwtExpiration(token) {
        try {
          const payload = JSON.parse(atob(token.split(".")[1]));
          return payload.exp;
        } catch (error) {
          console.error("Failed to parse JWT token:", error);
          return 0;
        }
      }

      function getCookie(name) {
        const value = "; " + document.cookie;
        const parts = value.split("; " + name + "=");

        if (parts.length == 2) {
          return parts.pop()?.split(";").shift();
        }
        return null;
      }

      function deleteCookie(name) {
        const date = new Date();
        // Set it expire in -1 days
        date.setTime(date.getTime() + -1 * 24 * 60 * 60 * 1000);
        // Set it
        document.cookie =
          name + "=; expires=" + date.toUTCString() + "; path=/";
      }

      const message = new MessageChannel();

      const messagePorts = new Map();

      messagePorts.set("druid.drd-fs", message.port2);

      // Configure loader with base URL only
      require.config({
        baseUrl: window.location.origin + "/out",
        colorScheme: "dark",
      });
      require(["vs/workbench/workbench.web.main"], (workbench) => {
        workbench.create(document.getElementById("root"), {
          productConfiguration: {
            extensionEnabledApiProposals: {
              "druid.drd-fs": [
                "fileSearchProvider",
                "textSearchProvider",
                "ipc",
              ],
            },
            nameShort: "Druid Web Editor",
            nameLong: "Druid Web Editor",
            applicationName: "code-web",
            dataFolderName: ".vscode-web",
            extensionsGallery: {
              serviceUrl: "https://open-vsx.org/vscode/gallery",
              itemUrl: "https://open-vsx.org/vscode/item",
              resourceUrlTemplate:
                "https://open-vsx.org/vscode/unpkg/{publisher}/{name}/{version}/{path}",
            },
          },
          folderUri: {
            scheme: "memfs",
            path: "/",
          },

          initialColorTheme: {
            themeType: "dark",
          },
          additionalBuiltinExtensions: [
            {
              scheme: window.location.protocol === "http:" ? "http" : "https",
              authority: window.location.host,
              path: "/extensions/webdav-fsprovider",
            },
          ],
          messagePorts,
        });

        message.port1.onmessage = (event) => {
          console.log("Main received message:", event.data);
          const credentialsData = getCookie("vscode-workbench-web-secrets");
          if (!credentialsData) {
            console.error("No credentials found");
            return;
          }

          let credentials;
          try {
            credentials = JSON.parse(credentialsData);
          } catch (error) {
            console.error("Failed to parse credentials:", error);
            return;
          }

          const updateCredentials = (c) => {
            message.port1.postMessage({
              type: "setCredentials",
              payload: {
                apikey: c.apikey,
                accessToken: c.accessToken,
                webdavUrl: c.webDavUrl,
                pathPrefix: c.pathPrefix,
              },
            });

            if (c.refreshToken) {
              const exp = getJwtExpiration(c.accessToken);
              const currentTime = Math.floor(Date.now() / 1000);
              const timeUntilRefresh = Math.max(
                0,
                (exp - currentTime - 60) * 1000
              );

              setTimeout(async () => {
                try {
                  const response = await fetch(
                    "https://auth.druid.gg/api/v1/refresh",
                    {
                      method: "POST",
                      headers: {
                        "Content-Type": "application/json",
                      },
                      body: JSON.stringify({ token: c.refreshToken }),
                    }
                  );

                  if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                  }

                  const refreshData = await response.json();
                  updateCredentials({
                    ...credentials,
                    accessToken: refreshData.accessToken,
                    refreshToken: refreshData.refreshToken,
                  });
                } catch (error) {
                  console.error("Failed to refresh token:", error);
                  // Could potentially redirect to login or show error message
                }
              }, timeUntilRefresh);
            }
          };
          updateCredentials(credentials);
        };
      });
    </script>
  </body>
</html>
